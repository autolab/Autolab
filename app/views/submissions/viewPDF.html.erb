<% @title = "Annotate Submission" %>

<% content_for :stylesheets do %>
<%= stylesheet_link_tag "annotations" %>

<style type="text/css">
  #pdf-doc canvas {
    margin-bottom: 20px;
    border: 1px solid #ddd;
  }

</style>
<% end %>

<% content_for :javascripts do %>
  <%= javascript_include_tag "pdf.js" %>
  <%= external_javascript_include_tag "lodash", "3.3.1" %>
  <%= javascript_include_tag "highlight.pack.js" %>

  <script type="application/javascript">

    <% if @cud.instructor || @cud.course_assistant then %>
      var isInstructor = true;
    <% else %>
      var isInstructor = false;
    <% end %>

    var annotations = <%=raw @annotations.to_json %>;
    var fileNameStr = "<%= @filename %>";
    var fileLink    = "<%= download_course_assessment_submission_path(@course, @assessment, @submission) %>";
    var cudEmailStr = "<%= @cud.email %>";
    // a json list of problems for this assessment
    var problems = <%=raw @problems.to_json %>;
    var basePath = "<%= course_assessment_submission_annotations_path(@course, @assessment, @submission) %>";

    <% if params[:header_position] %>
    var headerPositionStr = "<%= params[:header_position] %>";
    <% else %>
    var headerPositionStr = null;
    <% end %>

    PDFJS.workerSrc = "<%= asset_url 'pdf.worker.js' %>";


    var canvasContainer = document.getElementById("pdf-doc");
    //
    // Fetch the PDF document from the URL using promises
    //
    PDFJS.getDocument(fileLink).then(function(pdf) {
      var nmrPages = pdf.pdfInfo.numPages;

      for (var i=1; i<=nmrPages; i++) {
        // Using promise to fetch the page
        var nmrPagesRendered = 0;
        pdf.getPage(i).then(function(page) {
          var scale = 1.3;
          var viewport = page.getViewport(scale);

          //
          // Prepare canvas using PDF page dimensions
          //
          var div = document.createElement('div');
          div.className = "page-canvas"
          div.id = "page-canvas-"+page.pageIndex;

          var canvas = document.createElement('canvas');
          var ctx = canvas.getContext('2d');
          var renderContext = {
            canvasContext: ctx,
            viewport: viewport
          };
          
          canvas.height = viewport.height;
          canvas.width = viewport.width;

          div.appendChild(canvas);
          div.style.width = Math.floor(viewport.width) + "px";

          canvasContainer.appendChild(div);

          page.render(renderContext);
          nmrPagesRendered = nmrPagesRendered + 1;

          if (nmrPagesRendered == nmrPages) {
            initializeAnnotationsForPDF();
          }
        });

        
      }
    }).catch(function(error){
        //no error message is logged either
        console.log("Error occurred", error);
    });

  </script>
  <%= javascript_include_tag "annotations.js" %>

<% end %>

<h2>Submission Version <%=@submission.version%> for
<%= current_assessment_link %> (<%= @submission.course_user_datum.email %>)
</h2>
<hr>
<div class="row">
  <div class="col-md-3 annotationPane">
    <% if not (@submission.assessment.exam or @submission.assessment.course.exam_in_progress) %>
      <% mime_type = @submission.detected_mime_type %>
      <a href="<%= download_file_url(@submission) %>" title="Download Submission" class="btn">Download Original</a>
      <a href="<%= download_file_url(@submission) %>?annotated=true" title="Download Submission" class="btn">Download Annotated</a>
    <% end %>
  </div>
  <div class="col-md-9">
  <div id="pdf-doc" style="text-align: center;"></div>
  </div>
</div>
