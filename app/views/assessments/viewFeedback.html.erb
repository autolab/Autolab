<% if @jsonFeedback.nil? %>

<h2>Autograding Result for
<%= "#{@assessment.display_name} - #{@score.problem.name}" %>
(<%=@score.submission.course_user_datum.user.email %>)
</h2>
<div class="result-container">
  <div class="feedback-container result-pane">
    <div class="feedback-header">
      <h3>Feedback</h3>
      <div class="feedback-status__completed">
        Completed
      </div>
    </div>
    <pre>
      <%= @score.feedback %>
    </pre>
  </div>
  <div class="result-summary">
    <div class="result-pane result-fixed">
      <div class="feedback-header">
        <h3>Results</h3>
      </div>
        <% if !@scoreHash.nil? %>
          <table class="ui unstackable table">
            <tbody>
            <% @scoreHash.each do |key, value| %>
              <% if key != '_total' %>
                <tr>
                  <td><%= key %>:</td>
                  <td><%= value %></td>
                </tr>
              <% end %>
            <% end %>
            <tr>
              <td>Autograding Total:</td>
              <td><%= @scoreHash["_total"] %></td>
            </tr>
            <% if @score.grader && @score.grader.user%>
              <tr>
                <td>Graded By:</td>
                <td><%= @score.grader.user.email %></td>
              </tr>
            <% end %>
            </tbody>
          </table>
        <% else %>
          <p>
            Score for this problem: <%= @score.score.to_f().round(1) %>
          </p>
          <% if @score.grader && @score.grader.user%>
            <p>Graded By: <%= @score.grader.user.email %></p>
          <% end %>
        <% end %>
    </div>
  </div>

</div>

<% else %>
<%= render "semantic" %>

<% end %>
<!--
Yes, feedback is per problem but we show all annotations for this submission anyway. While this is not semantically correct, it offers a better UX than we had before. If we just show annotations attached to this problem, then where would we show annotations not attached to a problem at all?
-->

<% if @submission.annotations.count > 0 and @problemReleased %>
  <h2 style="margin-top: 1em">Remarks</h2>

  <% subs_by_problem = @submission.annotations.group_by(&:problem)
      subs_by_problem.each do |problem, annotations| %>
      <b> <%= problem.name %> </b>
      <ul class="collection">
      <!-- use custom sort b/c using ordering doesn't work with autograder output, archived files -->
      <%
        s_annotations = annotations.sort do |a,b|
        aFilename = @get_correct_filename.call(a)
        bFilename = @get_correct_filename.call(b)
        case
          when aFilename < bFilename
            -1
          when aFilename > bFilename
              1
          else
              a.line <=> b.line
          end
        end
        s_annotations.each do |annotation| %>
        <li class="collection-item">
              <div style='white-space: pre-wrap;'><%= annotation.comment%> </div>
              <% filename = @get_correct_filename.call(annotation)%>
              <span> 
                <b><%= annotation.value? ? sprintf("(%+.1f)", annotation.value) : "" %></b> 
                <%= link_to filename.to_s + ":"+ annotation.line.to_s , [:view, @course, @assessment, @submission, header_position: annotation.position] %> 
              </span>
        </li>
        <% end %>
      </ul>
    <% end %>

<% end %>
<%= javascript_include_tag "feedback.js" %>
