<% @unused_config_files = asmt_names %>
<% @course = course %>

<% content_for :stylesheets do %>
  <%= stylesheet_link_tag "install_assessment" %>
<% end %>

<% content_for :javascripts do %>
  <script>
      // dropdown toggle
      function toggleOptions(dropdownId, tableId) {
          if (!$(`#${tableId}`).parents().hasClass('import-incomplete')) {
              let show = document.getElementById(tableId);
              show.style.display = (show.style.display === "none")? "block" : "none";
              renderDropDownIcon(dropdownId, tableId);
          }
      }
      $(function() {
          $("#installSelected").click(function(e) {
              const msg = "Are you sure you want to import the selected assessments?";
              if (!window.confirm(msg))
                  return false;

              const $btn = $(e.target);
              $btn.text("Importing...");
              $btn.addClass("disabled");

              let checkedAsmts = $(".cbox").filter(':checked');
              let checkedAsmtNames = $.map(checkedAsmts, function(cbox){
                  return $(cbox).attr('name')
              })
              $.each(checkedAsmts, (i, cbox) => {
                  $(cbox).prop("disabled", true)
              })

              let importAsmtsUrl = new URL(`<%= url_for(importAssessments_course_assessments_url(@course)) %>`)
              $.post(importAsmtsUrl, {assessment_names: checkedAsmtNames}, function(data){
                  var errored = data.filter((entry) => entry.status === "FAIL").length > 0
                  if (errored) {
                      $('#error-install-help').show()
                  }
                  $.each(checkedAsmts, (i, cbox) => {
                      $(cbox).closest(".import-incomplete").removeClass("import-incomplete").addClass("import-complete")
                      if (data[i].status === `<%= AssessmentsController::IMPORT_ASMT_SUCCESS_STATUS %>`) {
                          $(cbox).closest("tr").addClass("import-success")
                          if (data[i].messages.length > 0) {
                              $(cbox).closest("tr").find('.import-success-messages').css('display', 'flex');
                              $(cbox).closest("tr").find('.messages-dropdown').text(data[i].messages.toString())
                              $(cbox).parent().hide()
                          } else {
                              $(cbox).closest("tr").find('.install-success-p').show()
                          }
                      } else if (data[i].status === `<%= AssessmentsController::IMPORT_ASMT_FAILURE_STATUS %>`) {
                          $(cbox).closest("tr").addClass("import-failure")
                          $(cbox).closest("tr").find('.install-failure-p').show()
                          $(cbox).closest("tr").find('.messages-dropdown').text(data[i].errors.toString())
                          $(cbox).parent().hide()
                      }

                  })
                  $btn.text("Import Complete");
              }).fail(function(xhr, status, error) {
                  alert("Assessment Import encountered an error: " + error + ": " + xhr.responseText);
                  $btn.removeClass("disabled");
                  $btn.text("Install Selected");
              });
          });
      });
      $(function() {
          $("#selectAll").click(function(e) {
              $(".cbox").prop("checked", true)
          })
          $("#unselectAll").click(function(e) {
              $(".cbox").prop("checked", false)
          })
      })
  </script>
<% end %>
<div class="install-asmt-container">
  <div>
    <a id="unselectAll" class="btn">Unselect All</a>
    <a id="selectAll" class="btn">Select All</a>
  </div>
  <div class="install-asmt-table-container">
    <table id="assessment_names" class="assessment-import-table import-incomplete">
      <colgroup>
        <col span="1">
        <col span="1">
      </colgroup>
      <tbody>
      <tr>
        <th>Assessment Name</th>
      </tr>
      <% @unused_config_files.each do |ass_file| %>
        <tr class="assessment-field checked">
          <td>
            <div
              class="error-dropdown"
              id="error-dropdown-<%= ass_file %>"
              onclick="toggleOptions('error-dropdown-<%= ass_file %>', '<%= ass_file %>-messages-dropdown')">
              <b class="install-success-p">
                Installed!
              </b>
              <b class="import-success-messages">
                Installed (with conditions)
                <i class="material-icons icon">
                  info
                </i>
              </b>
              <b class="install-failure-p">
                Failed to Install
              </b>
              <label>
                <%= check_box_tag ass_file, ass_file, true, class: 'cbox', id: "#{ass_file}_checkbox" %>
                <% link_to ass_file, importAssessment_course_assessments_path(@course, assessment_name: ass_file), method: :post, class: "collection-item", id: "#{ass_file}_checkbox_importLink" %>

                <span />
              </label>
              <%= ass_file %>
              <%= render "components/dropdown_icon", start_closed: true %>
            </div>
            <div
              id="<%= ass_file %>-messages-dropdown"
              class="messages-dropdown"
              style="display: none;">
              No error messages returned.
            </div>
          </td>
        </tr>
      <% end %>
      </tbody>
    </table>
  </div>

  <div id="error-install-help" style="display: none;">
    In order to fix failing assessment installs, go into the file system for the Autolab install and overwrite the
    files causing errors.
  </div>

  <div>
    <a id="installSelected" class="btn">Install Selected</a>
  </div>
</div>
