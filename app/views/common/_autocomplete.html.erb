<script type="application/javascript">
  /* requires @usersEncoded and @users to be set, i.e. via retrieve_autocompletion_data! */
  jQuery(function() {
    /* match user name/email with cud_id */
    /* escape_javascript prevents issues with backslashes in names, etc. */
    userData = {
      <% @usersEncoded.each do |k,v| %>
        "<%= j k %>": "<%= v %>",
      <% end %>
    };

    /* user autocomplete */
    $studentAutocompleteField = $('#student_autocomplete');
    $hiddenCUDField = $('<%= hiddenCUDField %>');
    $studentAutocompleteField.autocomplete({
      data: {
        <% @users.each do |k,v| %>
          "<%= j k %>": null,
        <% end %>
      }
    });

    /* track changes in student autocomplete field */
    $studentAutocompleteField.on('change', function() {
      // urlsafe_encode64 uses '-' instead of '+' and '_' instead of '/'
      // so we have to replace the corresponding characters
      encoded = window.btoa($studentAutocompleteField.val())
      encoded = encoded.replace("+", "-")
      encoded = encoded.replace("/", "_")
      $hiddenCUDField.val(userData[encoded]);
    });
  });
</script>
